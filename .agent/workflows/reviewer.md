---
description: 代码评审工作流。当需要分析未提交代码变更、检查潜在问题、评估代码质量时使用。
---

# 代码评审工作流

深度分析项目中未提交的代码变更，生成详细评审报告。

---

## 评审维度

| 维度 | 检查内容 | 严重性 |
|------|---------|--------|
| 功能影响 | 是否破坏现有功能、API 变更、行为改变 | 🔴 高 |
| 安全漏洞 | SQL 注入、XSS、敏感信息泄露、权限问题 | 🔴 高 |
| 性能问题 | N+1 查询、内存泄漏、阻塞操作、循环效率 | 🟡 中 |
| 架构问题 | 层级违规、循环依赖、职责不清、耦合过高 | 🟡 中 |
| 代码质量 | 命名规范、重复代码、复杂度、类型提示 | 🟢 低 |

---

## 评审流程

### 步骤 1: 获取变更列表

// turbo

```bash
git status --porcelain
```

// turbo

```bash
git diff --stat
```

### 步骤 2: 获取详细变更

// turbo

```bash
git diff
```

对于已暂存的变更：

// turbo

```bash
git diff --cached
```

### 步骤 3: 分析变更

针对每个变更文件，按以下清单逐项检查：

#### 功能影响检查

- [ ] 公共 API 签名是否变更？
- [ ] 函数/方法行为是否改变？
- [ ] 是否影响数据模型或数据库 schema？
- [ ] 事件/信号处理是否变化？
- [ ] 配置文件格式是否变更？

#### 安全漏洞检查

- [ ] 用户输入是否正确验证和转义？
- [ ] SQL 查询是否使用参数化？
- [ ] 密码/密钥是否硬编码？
- [ ] 文件路径是否可被注入？
- [ ] 权限检查是否充分？

#### 性能问题检查

- [ ] 循环内是否有 I/O 或数据库操作？
- [ ] 是否存在 N+1 查询模式？
- [ ] 大数据集操作是否有分页/流式处理？
- [ ] 是否存在阻塞 UI 线程的操作？
- [ ] 资源（文件句柄、连接）是否正确释放？

#### 架构问题检查

- [ ] 是否遵循项目分层架构？（UI → Service → Core → Data）
- [ ] 是否存在循环导入？
- [ ] 单一职责原则是否满足？
- [ ] 依赖注入是否正确使用？
- [ ] 新组件是否与现有抽象一致？

#### 代码质量检查

- [ ] 命名是否清晰表达意图？
- [ ] 函数长度是否合理（< 50 行）？
- [ ] 复杂度是否可接受（圈复杂度 < 10）？
- [ ] 类型提示是否完整？
- [ ] 是否有重复代码可提取？
- [ ] 注释是否必要且准确？

---

## 报告格式

生成的报告应包含以下结构：

```markdown
# 代码评审报告

## 概要

| 指标 | 值 |
|------|-----|
| 变更文件数 | X |
| 新增行数 | +Y |
| 删除行数 | -Z |
| 发现问题 | N 个 |

## 问题列表

### 🔴 严重问题

#### [问题标题]

- **文件**: `path/to/file.py`
- **行号**: L42-L45
- **类型**: [功能影响|安全漏洞|性能问题|架构问题]
- **描述**: 问题的详细描述
- **建议**: 修复建议

### 🟡 中等问题

...

### 🟢 轻微问题

...

## 无问题确认

如果某个维度没有发现问题，明确声明：

- ✅ 功能影响: 未发现问题
- ✅ 安全漏洞: 未发现问题

## 总结

整体评估和建议。
```

---

## 项目特定规则

### 架构层级

本项目遵循四层架构，违规导入需标记：

```
UI Layer (src/ui/)
    ↓ 只能调用
Service Layer (src/services/)
    ↓ 只能调用
Core Layer (src/core/)
    ↓ 只能调用
Data Layer (src/models/, config/)
```

违规示例：

- ❌ `src/services/` 导入 `src/ui/`
- ❌ `src/core/` 导入 `src/services/`
- ❌ `src/models/` 导入任何上层

### EventBus 使用

检查 EventBus 事件的正确使用：

- 事件名称是否在 `EventType` 枚举中定义？
- 是否正确处理线程切换？
- 订阅者是否正确取消订阅？

### 数据库操作

- 使用 `DatabaseManager` 而非直接 sqlite3
- 写操作需在事务中完成
- 考虑并发访问情况

---

## 快速命令

// turbo

查看所有未提交变更：

```bash
git diff HEAD
```

// turbo

查看特定文件变更：

```bash
git diff HEAD -- path/to/file.py
```

// turbo

查看变更文件列表（带状态）：

```bash
git status -s
```

---

## 审查清单

完成评审后确认：

- [ ] 所有变更文件已检查
- [ ] 每个维度都有结论（有问题或无问题）
- [ ] 问题标注了具体文件和行号
- [ ] 提供了可操作的修复建议
- [ ] 评估了变更的整体风险等级
